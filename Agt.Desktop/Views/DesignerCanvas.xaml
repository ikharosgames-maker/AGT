<UserControl x:Class="Agt.Desktop.Views.DesignerCanvas"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:m="clr-namespace:Agt.Desktop.Models"
             xmlns:conv="clr-namespace:Agt.Desktop.Converters"
             xmlns:local="clr-namespace:Agt.Desktop.Views"
             Focusable="False" IsTabStop="False">
    <UserControl.Resources>

        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility"/>

        <Style x:Key="DesignerItemStyle" TargetType="Border">
            <Setter Property="Background" Value="{Binding Background}"/>
            <Setter Property="BorderBrush" Value="#66B3E5FC"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                    <Setter Property="BorderThickness" Value="1.5"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <DataTemplate x:Key="Tpl_Overlay">
            <Grid>
                <Thumb DragDelta="MoveThumb_DragDelta"
               DragStarted="MoveThumb_DragStarted"
               DragCompleted="MoveThumb_DragCompleted"
               Cursor="SizeAll" Opacity="0" Background="Transparent"/>
                <Thumb Width="10" Height="10" HorizontalAlignment="Right" VerticalAlignment="Bottom"
               Cursor="SizeNWSE"
               Visibility="{Binding IsSelected, Converter={StaticResource BoolToVisibility}}"
               DragDelta="ResizeThumb_DragDelta"/>
            </Grid>
        </DataTemplate>

        <!-- LABEL -->
        <DataTemplate x:Key="Tpl_Label">
            <Border Style="{StaticResource DesignerItemStyle}"
              MouseLeftButtonDown="Item_MouseLeftButtonDown">
                <Grid>
                    <TextBlock Text="{Binding Label}" IsHitTestVisible="False"
                     FontSize="{Binding FontSize}" FontFamily="{Binding FontFamily}"
                     Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"/>
                    <ContentPresenter ContentTemplate="{StaticResource Tpl_Overlay}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- TEXTBOX -->
        <DataTemplate x:Key="Tpl_TextBox">
            <Border Style="{StaticResource DesignerItemStyle}"
              MouseLeftButtonDown="Item_MouseLeftButtonDown">
                <Grid>
                    <StackPanel>
                        <TextBlock Text="{Binding Label}" Margin="0,0,0,2" IsHitTestVisible="False"
                       FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                       Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"/>
                        <TextBox Width="{Binding Width}" Height="{Binding Height}" IsHitTestVisible="False"
                     Text="{Binding DefaultValue, UpdateSourceTrigger=PropertyChanged}"
                     Background="{Binding Background}"
                     Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"
                     FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                     Tag="{Binding FieldKey}" ToolTip="{Binding Placeholder}"/>
                    </StackPanel>
                    <ContentPresenter ContentTemplate="{StaticResource Tpl_Overlay}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- TEXTAREA -->
        <DataTemplate x:Key="Tpl_TextArea">
            <Border Style="{StaticResource DesignerItemStyle}"
              MouseLeftButtonDown="Item_MouseLeftButtonDown">
                <Grid>
                    <StackPanel>
                        <TextBlock Text="{Binding Label}" Margin="0,0,0,2" IsHitTestVisible="False"
                       FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                       Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"/>
                        <TextBox Width="{Binding Width}" Height="{Binding Height}" AcceptsReturn="True" TextWrapping="Wrap"
                     IsHitTestVisible="False"
                     Text="{Binding DefaultValue, UpdateSourceTrigger=PropertyChanged}"
                     Background="{Binding Background}"
                     Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"
                     FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                     Tag="{Binding FieldKey}" ToolTip="{Binding Placeholder}"/>
                    </StackPanel>
                    <ContentPresenter ContentTemplate="{StaticResource Tpl_Overlay}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- COMBOBOX -->
        <DataTemplate x:Key="Tpl_ComboBox">
            <Border Style="{StaticResource DesignerItemStyle}"
              MouseLeftButtonDown="Item_MouseLeftButtonDown">
                <Grid>
                    <StackPanel>
                        <TextBlock Text="{Binding Label}" Margin="0,0,0,2" IsHitTestVisible="False"
                       FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                       Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"/>
                        <ComboBox Width="{Binding Width}" IsEditable="{Binding IsEditable}" IsHitTestVisible="False"
                      SelectedValue="{Binding DefaultValue, UpdateSourceTrigger=PropertyChanged}"
                      Background="{Binding Background}"
                      Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"
                      FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                      Tag="{Binding FieldKey}" ItemsSource="{Binding Options}"/>
                    </StackPanel>
                    <ContentPresenter ContentTemplate="{StaticResource Tpl_Overlay}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- CHECKBOX -->
        <DataTemplate x:Key="Tpl_CheckBox">
            <Border Style="{StaticResource DesignerItemStyle}"
              MouseLeftButtonDown="Item_MouseLeftButtonDown">
                <Grid>
                    <CheckBox Content="{Binding Label}" IsHitTestVisible="False"
                    IsChecked="{Binding IsCheckedDefault, UpdateSourceTrigger=PropertyChanged}"
                    Background="{Binding Background}"
                    Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"
                    FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"/>
                    <ContentPresenter ContentTemplate="{StaticResource Tpl_Overlay}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- DATE -->
        <DataTemplate x:Key="Tpl_Date">
            <Border Style="{StaticResource DesignerItemStyle}"
              MouseLeftButtonDown="Item_MouseLeftButtonDown">
                <Grid>
                    <StackPanel>
                        <TextBlock Text="{Binding Label}" Margin="0,0,0,2" IsHitTestVisible="False"
                       FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                       Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"/>
                        <DatePicker Width="{Binding Width}" IsHitTestVisible="False"
                        SelectedDateFormat="Short" Tag="{Binding FieldKey}"
                        Background="{Binding Background}"
                        Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"/>
                    </StackPanel>
                    <ContentPresenter ContentTemplate="{StaticResource Tpl_Overlay}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- NUMBER -->
        <DataTemplate x:Key="Tpl_Number">
            <Border Style="{StaticResource DesignerItemStyle}"
              MouseLeftButtonDown="Item_MouseLeftButtonDown">
                <Grid>
                    <StackPanel>
                        <TextBlock Text="{Binding Label}" Margin="0,0,0,2" IsHitTestVisible="False"
                       FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                       Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"/>
                        <TextBox Width="{Binding Width}" Height="{Binding Height}" IsHitTestVisible="False"
                     Text="{Binding DefaultValue, UpdateSourceTrigger=PropertyChanged}"
                     Background="{Binding Background}"
                     Foreground="{Binding Background, Converter={StaticResource AutoContrast}}"
                     FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                     Tag="{Binding FieldKey}"/>
                    </StackPanel>
                    <ContentPresenter ContentTemplate="{StaticResource Tpl_Overlay}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- Selector -->
        <local:FieldTemplateSelector x:Key="FieldSelector"
                                 TplLabel="{StaticResource Tpl_Label}"
                                 TplTextBox="{StaticResource Tpl_TextBox}"
                                 TplTextArea="{StaticResource Tpl_TextArea}"
                                 TplComboBox="{StaticResource Tpl_ComboBox}"
                                 TplCheckBox="{StaticResource Tpl_CheckBox}"
                                 TplDate="{StaticResource Tpl_Date}"
                                 TplNumber="{StaticResource Tpl_Number}"/>
    </UserControl.Resources>

    <Grid Focusable="False">
        <Canvas x:Name="LassoLayer" IsHitTestVisible="False" />

        <ItemsControl x:Name="ItemsHost"
                  ItemsSource="{Binding Items}"
                  ItemTemplateSelector="{StaticResource FieldSelector}"
                  Focusable="False" IsTabStop="False">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <Canvas x:Name="RootCanvas"
                  Background="Transparent"
                  AllowDrop="True"
                  Drop="RootCanvas_Drop"
                  DragOver="RootCanvas_DragOver"
                  MouseLeftButtonDown="Canvas_MouseLeftButtonDown"
                  MouseMove="Canvas_MouseMove"
                  MouseLeftButtonUp="Canvas_MouseLeftButtonUp"
                  MouseLeave="Canvas_MouseLeave"
                  LostMouseCapture="Canvas_LostMouseCapture"
                  ContextMenuOpening="Canvas_ContextMenuOpening"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>

            <ItemsControl.ItemContainerStyle>
                <Style TargetType="ContentPresenter">
                    <Setter Property="Panel.ZIndex" Value="{Binding ZIndex}"/>
                    <Setter Property="Canvas.Left" Value="{Binding X}"/>
                    <Setter Property="Canvas.Top"  Value="{Binding Y}"/>
                    <Setter Property="Focusable" Value="False"/>
                    <Setter Property="IsHitTestVisible" Value="True"/>
                </Style>
            </ItemsControl.ItemContainerStyle>
        </ItemsControl>
    </Grid>
</UserControl>
