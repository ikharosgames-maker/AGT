<UserControl x:Class="Agt.Desktop.Views.ComponentViewerControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:views="clr-namespace:Agt.Desktop.Views">
    

    <!-- Forward Mode jako attached property na nejbližší ItemsControl,
       aby ho DataTemplates (které hledají AncestorType=ItemsControl) vždy „viděly“. -->
    <ItemsControl x:Name="ItemsHost"
                ItemsSource="{Binding Items, RelativeSource={RelativeSource AncestorType={x:Type views:ComponentViewerControl}}}"
                views:RenderModeHelper.Mode="{Binding Mode, RelativeSource={RelativeSource AncestorType={x:Type views:ComponentViewerControl}}}">
        <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
                <views:AutoSizeCanvas/>
            </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>

        <ItemsControl.ItemContainerStyle>
            <Style TargetType="ContentPresenter">
                <Setter Property="Canvas.Left"  Value="{Binding X}"/>
                <Setter Property="Canvas.Top"   Value="{Binding Y}"/>
                <Setter Property="Panel.ZIndex" Value="{Binding ZIndex}"/>
            </Style>
        </ItemsControl.ItemContainerStyle>

        <!-- Nepřetěžujeme ItemTemplate – implicitní DataTemplates z ComponentTemplates.xaml se aplikují podle typu.
         ContentPresenter zde pouze zachovává výchozí chování. -->
        <ItemsControl.ItemTemplate>
            <DataTemplate>
                <ContentPresenter Content="{Binding}"/>
            </DataTemplate>
        </ItemsControl.ItemTemplate>
    </ItemsControl>
</UserControl>
