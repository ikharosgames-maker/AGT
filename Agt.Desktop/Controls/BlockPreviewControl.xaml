<UserControl x:Class="Agt.Desktop.Controls.BlockPreviewControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:m="clr-namespace:Agt.Desktop.Models"
             mc:Ignorable="d"
             d:DesignHeight="220" d:DesignWidth="360"
             SnapsToDevicePixels="True"
             UseLayoutRounding="True"
             Background="Transparent"
             Width="{Binding PreviewWidth, FallbackValue=320, TargetNullValue=320}"
             Height="{Binding PreviewHeight, FallbackValue=200, TargetNullValue=200}">

    <UserControl.Resources>
        <!-- LABEL -->
        <DataTemplate DataType="{x:Type m:LabelField}">
            <Border Width="{Binding Width}" Height="{Binding Height}"
                    Background="{Binding Background}" BorderBrush="#666" BorderThickness="1" CornerRadius="2" Padding="6,0">
                <TextBlock Text="{Binding Label}"
                           Foreground="{Binding Foreground}"
                           FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                           VerticalAlignment="Center"/>
            </Border>
        </DataTemplate>

        <!-- TEXTBOX -->
        <DataTemplate DataType="{x:Type m:TextBoxField}">
            <Border Width="{Binding Width}" Height="{Binding Height}"
                    Background="{Binding Background}" BorderBrush="#666" BorderThickness="1" CornerRadius="2" Padding="6,4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="{Binding Label}" Margin="0,0,0,4"
                               Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}"/>
                    <TextBox Grid.Row="1"
                             Text="{Binding DefaultValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                             BorderThickness="0" VerticalContentAlignment="Center"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- TEXTAREA -->
        <DataTemplate DataType="{x:Type m:TextAreaField}">
            <Border Width="{Binding Width}" Height="{Binding Height}"
                    Background="{Binding Background}" BorderBrush="#666" BorderThickness="1" CornerRadius="2" Padding="6,4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="{Binding Label}" Margin="0,0,0,4"
                               Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}"/>
                    <TextBox Grid.Row="1"
                             Text="{Binding DefaultValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             AcceptsReturn="True" TextWrapping="Wrap"
                             Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                             BorderThickness="0" VerticalContentAlignment="Top"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- NUMBER -->
        <DataTemplate DataType="{x:Type m:NumberField}">
            <Border Width="{Binding Width}" Height="{Binding Height}"
                    Background="{Binding Background}" BorderBrush="#666" BorderThickness="1" CornerRadius="2" Padding="6,4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="{Binding Label}" Margin="0,0,0,4"
                               Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}"/>
                    <TextBox Grid.Row="1"
                             Text="{Binding DefaultValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"
                             BorderThickness="0" VerticalContentAlignment="Center"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- DATE -->
        <DataTemplate DataType="{x:Type m:DateField}">
            <Border Width="{Binding Width}" Height="{Binding Height}"
                    Background="{Binding Background}" BorderBrush="#666" BorderThickness="1" CornerRadius="2" Padding="6,4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="{Binding Label}" Margin="0,0,0,4"
                               Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}"/>
                    <DatePicker Grid.Row="1"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- COMBOBOX -->
        <DataTemplate DataType="{x:Type m:ComboBoxField}">
            <Border Width="{Binding Width}" Height="{Binding Height}"
                    Background="{Binding Background}" BorderBrush="#666" BorderThickness="1" CornerRadius="2" Padding="6,4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Text="{Binding Label}" Margin="0,0,0,4"
                               Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}"/>
                    <ComboBox Grid.Row="1"
                              IsEditable="{Binding IsEditable}"
                              ItemsSource="{Binding Options}"
                              Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- CHECKBOX -->
        <DataTemplate DataType="{x:Type m:CheckBoxField}">
            <Border Width="{Binding Width}" Height="{Binding Height}"
                    Background="{Binding Background}" BorderBrush="#666" BorderThickness="1" CornerRadius="2" Padding="6,4">
                <CheckBox IsChecked="{Binding IsCheckedDefault}"
                          Content="{Binding Label}" VerticalAlignment="Center"
                          Foreground="{Binding Foreground}" FontFamily="{Binding FontFamily}" FontSize="{Binding FontSize}"/>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <!-- Obal BEZ paddingu/marginu, aby celková velikost = přesně Header(24) + Canvas(PreviewHeight) -->
    <Border CornerRadius="8"
            BorderThickness="1"
            BorderBrush="{DynamicResource {x:Static SystemColors.ActiveBorderBrushKey}}"
            Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}"
            Padding="0">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="24"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Hlavička (24 px) -->
            <DockPanel Grid.Row="0" LastChildFill="False" Margin="6,0,6,0">
                <TextBlock Text="{Binding Title}" FontWeight="Bold"
                           Foreground="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}"/>
                <TextBlock Text="{Binding Version}" FontSize="11" Opacity="0.7" Margin="8,0,0,0"
                           Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"/>
            </DockPanel>

            <!-- Tělo: absolutní layout; rozměr = přesně PreviewWidth×PreviewHeight -->
            <Canvas Grid.Row="1"
                    Width="{Binding PreviewWidth, FallbackValue=320}"
                    Background="{DynamicResource {x:Static SystemColors.ControlLightBrushKey}}"
                    SnapsToDevicePixels="True" Margin="19,0,19,10">
                <ItemsControl ItemsSource="{Binding Components}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                            <Setter Property="Canvas.Top"  Value="{Binding Y}"/>
                            <Setter Property="Panel.ZIndex" Value="{Binding ZIndex}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <!-- DataTemplates pro typy jsou definované výše -->
                </ItemsControl>
            </Canvas>
        </Grid>
    </Border>
</UserControl>
